<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Qlik API Barebones</title>

    <link rel="stylesheet" href="https://playground-sense.qlik.com/showcase/resources/autogenerated/qlik-styles.css">
    <link href="https://fonts.googleapis.com/css?family=Anton%7COswald" rel="stylesheet">
    <link href="style.css" rel="stylesheet">

    <script src="http://d3js.org/d3.v3.min.js" language="JavaScript"></script>
    <script src="//d3js.org/topojson.v1.min.js"></script>
    <script type="text/javascript" src="/resources/liquidFillGauge.js"></script>
    <script type="text/javascript" src="/resources/liquidFillSupport.js"></script>
  </head>
<body>
    <div id="container">

        <header class="header">

            <div class="headerContent">
                <h1 class="title">
                    SUSTAINABLE DEVELOPMENT GOAL 14
                </h1>
                <h3>
                    Conserve and sustainably use the oceans, seas and marine resources for sustainable development
                </h3>
            </div>

            <img class="headerIcon" src="./resources/images/header-icon.png" alt="Fish">
        </header>

        <div id="contentContainer">
            <!--  Content goes here!-->
            <section>
                <h2>Interactive Map</h2>
                <p class="info">To help governments and stakeholders better understand the Sustainable Development Goals, and the effects of their interacting organizations we have created an a map to highlight the impact countries have on their
                    oceans.</p>

        <script>
            /* JavaScript goes here. */
            // globals used in graph
            var mapdata = {};
            var palette = ['#009933','#669900','#99cc00','#cccc00','#c7dc09','#edf933','#ffcc00', '#ff9933', '#ff6600','#ff5050'];
            var width = 960, height = 960;
            var minDocCount = 0, quantiles = {};
            // projection definitions
            var projection = d3.geo.mercator()
                .scale((width + 1) / 2 / Math.PI)
                .translate([width/2, height/2])
                .precision(.1);
            var path = d3.geo.path().projection(projection);
            var graticule = d3.geo.graticule();
            // SVG related definitions
            var svg = d3.select('body').append('svg')
                        .attr({'width': width, 'height': height})
                        .append('g');
            var filter = svg.append('defs')
                .append('filter')
                .attr({'x':0, 'y':0, 'width':1, 'height':1, 'id':'gray-background'});
            filter.append('feFlood')
                .attr('flood-color', '#f2f2f2')
                .attr('result', 'COLOR');
            filter.append('feMorphology')
                .attr('operator', 'dilate')
                .attr('radius', '.9')
                .attr('in', 'SourceAlpha')
                .attr('result', 'MORPHED');
            filter.append('feComposite')
                .attr('in', 'SourceGraphic')
                .attr('in2', 'MORPHED')
                .attr('result', 'COMP1');
            filter.append('feComposite')
                .attr('in', 'COMP1')
                .attr('in2', 'COLOR');

            svg.append("path")
                .datum(graticule)
                .attr("class", "graticule")
                .attr("d", path);

            d3.json('mockelasticdata.json', function(error, mockdata) {
                if (error) return console.error(error);
                console.log('mockdata',mockdata);
                mapdata = mockdata;
                draw(mockdata)
            });

            function draw(data) {
                // var localstoreWorldData = localStorage.getItem('worldmapData');
                // if (localstoreWorldData && localstoreWorldData.length) {
                //     localstoreWorldData = JSON.parse(localstoreWorldData);
                //     console.log('localstoreWorldData',localstoreWorldData);
                //     if (localstoreWorldData) {
                //         processWorldD(localstoreWorldData, data);
                //         //no need proceed further
                //         return;
                //     }
                // }
                d3.json('world.json', function(error, world) {
                    if (error) return console.error(error);
                    console.log('world',world);
                    processWorldD(world, data);
                    //localStorage.setItem('worldmapData', JSON.stringify(world));
                });
            }
            function processWorldD(world, data) {
                    for(var idx=0; idx < data.aggregations.world_map.buckets.length; idx++) {
                        var cCode = data.aggregations.world_map.buckets[idx].key.toUpperCase();
                        var doc_count = data.aggregations.world_map.buckets[idx].doc_count;
                        for(var wdx=0; wdx < world.objects.subunits.geometries.length; wdx++) {
                            var cName = world.objects.subunits.geometries[wdx].id.toUpperCase();
                            if (cCode === cName) {
                                world.objects.subunits.geometries[wdx].properties.doc_count = doc_count;
                            }
                        }
                    }
                    var subunits = topojson.feature(world, world.objects.subunits);
                    subunits.features = subunits.features.filter(function(d){ return d.id !== "ATA"; });
                    console.log('subunits',subunits);
                    minDocCount = d3.min(subunits.features, function(d){ return d.properties.doc_count; });
                    console.log('minDocCount',minDocCount);
                    var doc_counts = subunits.features.map(function(d){ return d.properties.doc_count; });
                    doc_counts = doc_counts.filter(function(d){ return d; }).sort(d3.ascending);
                    //console.log('doc_counts',doc_counts);
                    quantiles['0.95'] = d3.quantile(doc_counts, '0.95');
                    var countries = svg.selectAll('path.subunit')
                        .data(subunits.features).enter();
                    countries.insert('path', '.graticule')
                        .attr('class', function(d) { return 'subunit ca'+d.id; })
                        .style('fill', heatColor)
                        .attr('d', path)
                        .on('mouseover',mouseoverLegend).on('mouseout',mouseoutLegend)
                        .on('click', coutryclicked);
                    
                    countries.append('svg:text')
                        .attr('class', function(d){ return 'subunit-label la'+d.id+d.properties.name.replace(/[ \.#']+/g,''); })
                        //.attr('transform', function(d) { return 'translate('+ path.centroid(d) +')'; })
                        .attr('transform', function(d) { return 'translate('+(width-(5*d.properties.name.length))+','+(15)+')'; })
                        .attr('dy', '.35em')
                        .attr('filter', 'url(#gray-background)')
                        .append('svg:tspan')
                        .attr('x', 0)
                        .attr('dy', 5)
                        .text(function(d) { return d.properties.name; })
                        .append('svg:tspan')
                        .attr('x', 0)
                        .attr('dy', 20)
                        .text(function(d) { return d.properties.doc_count ? d.properties.doc_count : ''; });
            }

            function mouseoverLegend(datum, index) {
                d3.selectAll('.subunit-label.la'+datum.id+datum.properties.name.replace(/[ \.#']+/g,''))
                    .style('display', 'inline-block');
                d3.selectAll('.subunit.ca'+datum.id)
                    .style('fill', '#cc6699');
            }

            function mouseoutLegend(datum, index) {
                d3.selectAll('.subunit-label.la'+datum.id+datum.properties.name.replace(/[ \.#']+/g,''))
                    .style('display', 'none');
                d3.selectAll('.subunit.ca'+datum.id)
                    .style('fill', heatColor(datum));
            }

            function coutryclicked(datum, index) {
                //filter event for this country should be applied here
                console.log('coutryclicked datum', datum);
            }
            function heatColor(d) {
                if (quantiles['0.95'] === 0 && minDocCount === 0) return '#F0F0F0';
                if (!d.properties.doc_count) return '#F0F0F0';
                if (d.properties.doc_count > quantiles['0.95']) return palette[(palette.length - 1)];
                if (quantiles['0.95'] == minDocCount) return palette[(palette.length-1)];
                var diffDocCount = quantiles['0.95'] - minDocCount;
                var paletteInterval = diffDocCount / palette.length;
                var diffDocCountDatum = quantiles['0.95'] - d.properties.doc_count;
                var diffDatumDiffDoc = diffDocCount - diffDocCountDatum;
                var approxIdx = diffDatumDiffDoc / paletteInterval;
                if (!approxIdx || Math.floor(approxIdx) === 0) approxIdx = 0;
                else approxIdx = Math.floor(approxIdx) - 1;
                return palette[approxIdx];
            }
        </script>
                         
            </section>

            <section>
                <h2>Interactive Map</h2>
                <p class="info">To help governments and stakeholders better understand the Sustainable Development Goals, and the effects of their interacting organizations we have created an a map to highlight the impact countries have on their
                    oceans.</p>
            </section>

            <section>
                <h2>Interactive Map</h2>
                <p class="info">To help governments and stakeholders better understand the Sustainable Development Goals, and the effects of their interacting organizations we have created an a map to highlight the impact countries have on their
                    oceans.</p>
            </section>

            <section>
                <h2>Interactive Map</h2>
                <p class="info">To help governments and stakeholders better understand the Sustainable Development Goals, and the effects of their interacting organizations we have created an a map to highlight the impact countries have on their
                    oceans.</p>
            </section>

            <section>
                <h2>Interactive Map</h2>
                <p class="info">To help governments and stakeholders better understand the Sustainable Development Goals, and the effects of their interacting organizations we have created an a map to highlight the impact countries have on their
                    oceans.</p>
            </section>

            <section>
                <h2>Interactive Map</h2>
                <p class="info">To help governments and stakeholders better understand the Sustainable Development Goals, and the effects of their interacting organizations we have created an a map to highlight the impact countries have on their
                    oceans.</p>
            </section>


            <section>
                <h2>Interactive Map</h2>
                <p class="info">To help governments and stakeholders better understand the Sustainable Development Goals, and the effects of their interacting organizations we have created an a map to highlight the impact countries have on their
                    oceans.</p>
            </section>



            <section>
                <h2>Interactive Map</h2>
                <p class="info">To help governments and stakeholders better understand the Sustainable Development Goals, and the effects of their interacting organizations we have created an a map to highlight the impact countries have on their
                    oceans.</p>
            </section>


            <section>
                <h2>Interactive Map</h2>
                <p class="info">To help governments and stakeholders better understand the Sustainable Development Goals, and the effects of their interacting organizations we have created an a map to highlight the impact countries have on their
                    oceans.</p>
            </section>

            <section>
                <h2>Interactive Map</h2>
                <p class="info">To help governments and stakeholders better understand the Sustainable Development Goals, and the effects of their interacting organizations we have created an a map to highlight the impact countries have on their
                    oceans.</p>
            </section>

            <section>
                <h2>Interactive Map</h2>
                <p class="info">To help governments and stakeholders better understand the Sustainable Development Goals, and the effects of their interacting organizations we have created an a map to highlight the impact countries have on their
                    oceans.</p>
            </section>



        </div>
    </div>

    <script type="text/javascript" src="https://playground-sense.qlik.com/showcase/resources/assets/external/requirejs/require.js"></script>
    <script type="text/javascript" src="/resources/script.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.js"></script>
    <script type="text/javascript">
        $(document).ready(function() {
            var $header = $("header"),
                $clone = $header.before($header.clone().addClass("clone"));

            $(window).on("scroll", function() {
                var fromTop = $("body").scrollTop();
                $('body').toggleClass("down", (fromTop > 120));
            });
        });
    </script>

    <script>

    </script>

  <script type="text/javascript" src="https://playground-sense.qlik.com/showcase/resources/assets/external/requirejs/require.js"></script>
  <script type="text/javascript" src="/resources/statistics.js"></script>

  <script type="text/javascript">

    var svg1_settings = [];
    svg1_settings.push(["width", "33%"]);
    svg1_settings.push(["height", "250"]);
    svg1_settings.push(["float", "left"]);
    var liqGauge1 = add_liquid_gauge(svg1_settings, "fillgauge1", 0);

    var svg2_settings = [];
    svg2_settings.push(["width", "33%"]);
    svg2_settings.push(["height", "250"]);
    svg2_settings.push(["float", "right"]);
    var liqGauge2 = add_liquid_gauge(svg2_settings, "fillgauge2", 0);

    var svg3_settings = [];
    svg3_settings.push(["width", "33%"]);
    svg3_settings.push(["height", "250"]);
    svg3_settings.push(["float", "center"]);
    // var gauge_config = liquidFillGaugeDefaultSettings();
    // gauge_config.circleColor = "#D4AB6A";
    // gauge_config.textColor = "#553300";
    // gauge_config.waveTextColor = "#805615";
    // gauge_config.waveColor = "#AA7D39";
    // gauge_config.circleThickness = 0.1;
    // gauge_config.circleFillGap = 0.1;
    // gauge_config.textVertPosition = 0.8;
    // gauge_config.waveAnimateTime = 1000;
    // gauge_config.waveHeight = 0.3;
    // gauge_config.waveCount = 3;
    var liqGauge3 = add_liquid_gauge(svg3_settings, "fillgauge3", 0/*, gauge_config*/);

    function update_top_displays_cb(data) {
        if (data[4].includes("Commitment Title-Partners")) {
            // Top commitments
            update_liquid_gauge(liqGauge1, data[3].toFixed(1));
        } else if (data[4].includes("Country-Partners")) {
            // Top partners
            update_liquid_gauge(liqGauge2, data[3].toFixed(1));
        } else if (data[4].includes("Partners-Lead entity")) {
            // Top entities
            update_liquid_gauge(liqGauge3, data[3].toFixed(1));
        }
    }

    // Main program
    main(update_top_displays_cb);

  </script>
</body>

<footer>
    <p>Created by <a href="http://www.ecmjohnson.com/">Erik Johnson</a>, Moh, <a href="http://www.travisswandesign.ca">Travis Swan</a>, Winston Yang Hong, Yonis, Ahmed Sakr, Arsalan Sadig, Josh Campitelli for the <a href="https://branch-blog.qlik.com/qlikhacks-2018-an-ottawa-hackathon-ca7c63d69f1e">2018 QlikHack</a></p>
    <img src="https://sustainabledevelopment.un.org/content/images/sdgskp.png"/>
    <img src="https://www.qlik.com/us/-/media/images/qlik/global/qlik-logo-2x.png?h=94&w=308&la=en&hash=8CD1A612A7DE97F79A646EAFFA8721F5FBF9C751"/>
</footer>

</html>
